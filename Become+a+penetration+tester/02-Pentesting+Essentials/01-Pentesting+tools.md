# Pentesting Tools
## Scan network with Nmap
- Nmap is checking the most common services to see if they're open on the host. It does this by starting to open a connection to the service, and then closing it down before the connection is complete. This is called a TCP SYN ping, and it works by sending an empty TCP packet with the SYN flag set and waiting for the host to respond with the standard SYN-ACK response. While a normal connection would be completed by sending back an ACK, Nmap instead cancels the connection before it completes.
- nmap -sn
    - Subnet
    - nmap -sn 74.125.130.104
        ```
        @D-Sensei ➜ /workspaces/Prac (main) $ nmap -sn  www.google.com
        Starting Nmap 7.80 ( https://nmap.org ) at 2024-04-03 06:50 UTC
        Nmap scan report for www.google.com (142.250.70.100)
        Host is up (0.0033s latency).
        Other addresses for www.google.com (not scanned): 2404:6800:4009:81f::2004
        rDNS record for 142.250.70.100: pnbomb-ac-in-f4.1e100.net
        ```
- nmap -PS
    - Port scan capital
    - nmap -PS 74.125.130.104
        ```Output
        @D-Sensei ➜ /workspaces/Prac (main) $ nmap -PS  74.125.130.104
        Starting Nmap 7.80 ( https://nmap.org ) at 2024-04-03 06:59 UTC
        Nmap scan report for sb-in-f104.1e100.net (74.125.130.104)
        Host is up (0.057s latency).
        Not shown: 998 filtered ports
        PORT    STATE SERVICE
        80/tcp  open  http
        443/tcp open  https

        Nmap done: 1 IP address (1 host up) scanned in 5.68 seconds

      ```

- nmap -sU 74.125.130.104
    - UDP port scan
    - 
    ```
    root ➜ /workspaces/Prac (main) $ nmap -sU 74.125.130.104
    Starting Nmap 7.80 ( https://nmap.org ) at 2024-04-03 07:05 UTC
    Nmap scan report for sb-in-f104.1e100.net (74.125.130.104)
    Host is up (0.058s latency).
    All 1000 scanned ports on sb-in-f104.1e100.net (74.125.130.104) are open|filtered

    Nmap done: 1 IP address (1 host up) scanned in 6.74 seconds
    ```
- nmap -sU -P0 74.125.130.104
    - -P0 Skip the ping check
    - takes time

- nmap -sV -p22 74.125.130.104
    - sV check version 
    - p22 port number 22
    ```
    root ➜ /workspaces/Prac (main) $ nmap -sV -p22 74.125.130.104
    Starting Nmap 7.80 ( https://nmap.org ) at 2024-04-03 07:11 UTC
    Nmap scan report for sb-in-f104.1e100.net (74.125.130.104)
    Host is up (0.055s latency).

    PORT   STATE    SERVICE VERSION
    22/tcp filtered ssh

    Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
    Nmap done: 1 IP address (1 host up) scanned in 1.34 seconds
    ```

- nmap -sSUV -p U:53,111,137,T:21-25,80,139,8080 10.0.2.8
    - sSUV show both TCP and UDP
    - -p port 
    - U: means udp ports
    - T: means TCP ports
    ```Output
    nmap -sSUV -p U:53,111,137,T:21-25,80,139,8080 74.125.130.104
    Starting Nmap 7.80 ( https://nmap.org ) at 2024-04-03 07:23 UTC
    Nmap scan report for sb-in-f104.1e100.net (74.125.130.104)
    Host is up (0.055s latency).

    PORT     STATE         SERVICE     VERSION
    21/tcp   filtered      ftp
    22/tcp   filtered      ssh
    23/tcp   filtered      telnet
    24/tcp   filtered      priv-mail
    25/tcp   filtered      smtp
    80/tcp   open          http        gws
    139/tcp  filtered      netbios-ssn
    8080/tcp filtered      http-proxy
    53/udp   open|filtered domain
    111/udp  open|filtered rpcbind
    137/udp  open|filtered netbios-ns
    1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
    SF-Port80-TCP:V=7.80%I=7%D=4/3%Time=660D03DE%P=x86_64-pc-linux-gnu%r(GetRe
    SF:quest,15E0,"HTTP/1\.0\x20200\x20OK\r\nDate:\x20Wed,\x2003\x20Apr\x20202
    SF:4\x2007:23:11\x20GMT\r\nExpires:\x20-1\r\nCache-Control:\x20private,\x2
    SF:0max-age=0\r\nContent-Type:\x20text/html;\x20charset=ISO-8859-1\r\nCont
    SF:ent-Security-Policy-Report-Only:\x20object-src\x20'none';base-uri\x20's
    SF:elf';script-src\x20'nonce-f6AA2XRFhetOEOI33iXVFA'\x20'strict-dynamic'\x
    SF:20'report-sample'\x20'unsafe-eval'\x20'unsafe-inline'\x20https:\x20http
    SF::;report-uri\x20https://csp\.withgoogle\.com/csp/gws/other-hp\r\nP3P:\x
    SF:20CP=\"This\x20is\x20not\x20a\x20P3P\x20policy!\x20See\x20g\.co/p3phelp
    SF:\x20for\x20more\x20info\.\"\r\nServer:\x20gws\r\nX-XSS-Protection:\x200
    SF:\r\nX-Frame-Options:\x20SAMEORIGIN\r\nSet-Cookie:\x201P_JAR=2024-04-03-
    SF:07;\x20expires=Fri,\x2003-May-2024\x2007:23:11\x20GMT;\x20path=/;\x20do
    SF:main=\.google\.com;\x20Secure\r\nSet-Cookie:\x20AEC=Ae3NU9NeRMGLQExPhIB
    SF:WWzrDR2BpmfVwLbBL3A8aCKSZi-BkoQ1w12eE3g;\x20expires=Mon,\x2030-Sep-2024
    SF:\x2007:23:11\x20GMT;\x20path=/;\x20domain=\.google\.com;\x20Secure;\x20
    SF:HttpOnly;\x20SameSite=lax\r\nSet-Cookie:\x20NID=512=d3jkz_N4aqP_p95A949
    SF:uiLo2iKeel6d-VQ1apB4oCp_1RUVo1rlYNGrWa5kVFnoWQoJZyjuQ")%r(HTTPOptions,7
    SF:0F,"HTTP/1\.0\x20405\x20Method\x20Not\x20Allowed\r\nAllow:\x20GET,\x20H
    SF:EAD\r\nDate:\x20Wed,\x2003\x20Apr\x202024\x2007:23:11\x20GMT\r\nContent
    SF:-Type:\x20text/html;\x20charset=UTF-8\r\nServer:\x20gws\r\nContent-Leng
    SF:th:\x201592\r\nX-XSS-Protection:\x200\r\nX-Frame-Options:\x20SAMEORIGIN
    SF:\r\n\r\n<!DOCTYPE\x20html>\n<html\x20lang=en>\n\x20\x20<meta\x20charset
    SF:=utf-8>\n\x20\x20<meta\x20name=viewport\x20content=\"initial-scale=1,\x
    SF:20minimum-scale=1,\x20width=device-width\">\n\x20\x20<title>Error\x2040
    SF:5\x20\(Method\x20Not\x20Allowed\)!!1</title>\n\x20\x20<style>\n\x20\x20
    SF:\x20\x20\*{margin:0;padding:0}html,code{font:15px/22px\x20arial,sans-se
    SF:rif}html{background:#fff;color:#222;padding:15px}body{margin:7%\x20auto
    SF:\x200;max-width:390px;min-height:180px;padding:30px\x200\x2015px}\*\x20
    SF:>\x20body{background:url\(//www\.google\.com/images/errors/robot\.png\)
    SF:\x20100%\x205px\x20no-repeat;padding-right:205px}p{margin:11px\x200\x20
    SF:22px;overflow:hidden}ins{color:#777;text-decoration:none}a\x20img{borde
    SF:r:0}@media\x20screen\x20and\x20\(max-width:772px\){body{background:none
    SF:;margin-top:0;max-width:none;padding-right:0}}#l");

    Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
    Nmap done: 1 IP address (1 host up) scanned in 105.19 seconds
    ```

- nmap -O -PS 74.125.130.104
    - O operating System
    - Linux Example
    ```opt
    root ➜ /workspaces/Prac (main) $ nmap -O -PS 74.125.130.104
    Starting Nmap 7.80 ( https://nmap.org ) at 2024-04-03 07:28 UTC
    Nmap scan report for sb-in-f104.1e100.net (74.125.130.104)
    Host is up (0.055s latency).
    Not shown: 998 filtered ports
    PORT    STATE SERVICE
    80/tcp  open  http
    443/tcp open  https
    Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
    Device type: general purpose
    Running (JUST GUESSING): FreeBSD 8.X (87%), OpenBSD 4.X (87%)
    OS CPE: cpe:/o:freebsd:freebsd:8.2 cpe:/o:openbsd:openbsd:4.0
    Aggressive OS guesses: FreeBSD 8.2-RELEASE (87%), OpenBSD 4.0 (87%)
    No exact OS matches for host (test conditions non-ideal).

    OS detection performed. Please report any incorrect results at https://nmap.org/submit/ .
    Nmap done: 1 IP address (1 host up) scanned in 10.03 seconds
    ```

- root ➜ /usr/share/nmap/scripts $ ls
    - To Check payload related nmap
    - We can see these in its scripts directory. These provide many advanced capabilities. Let's run one. We'll use the rexec brute force test to extract credentials via port 512. We can do this by using the --script argument. Here we see a list of valid credentials for the Metasploitable server.
    ```
    root ➜ /usr/share/nmap/scripts $ nmap 10.0.2.8 -Pn -p512 --script=rexec-brute
    Starting Nmap 7.80 ( https://nmap.org ) at 2024-04-03 07:41 UTC
    Nmap scan report for 10.0.2.8
    Host is up.

    PORT    STATE    SERVICE
    512/tcp filtered exec

    Nmap done: 1 IP address (1 host up) scanned in 2.23 seconds
    ```
    ![](images/namp+script+brute.png)

## A netcat refresher




## Capture packets with tcpdump
## Work with netstat, nbtstat and arp
- `netstat` is a command-line tool that is used to display network connections, routing tables, interface statistics, and multicast memberships. It is available on various operating systems, including Windows, Linux, and macOS.
- *.* in forign address incdicate that the connection hasn't yet been made as we'd expect for UDP
- Example of Netstat
    ```powershell
    @D-Sensei ➜ /workspaces/Prac (main) $ netstat
    Active Internet connections (w/o servers)
    Proto Recv-Q Send-Q Local Address           Foreign Address         State      
    tcp        0      0 localhost:40825         localhost:43506         ESTABLISHED
    tcp        0      0 dd953be2-cf3d-49f:47734 52.239.249:microsoft-ds ESTABLISHED
    tcp        0      1 dd953be2-cf3d-49f:46752 169.254.169.254:http    SYN_SENT   
    tcp        0      0 dd953be2-cf3d-49f:58730 52.148.90.111:https     ESTABLISHED
    tcp        0      0 dd953be2-cf3d-49f:53108 216.24.57.4:https       ESTABLISHED
    tcp        0      0 dd953be2-cf3d-49f:49764 52.148.90.111:https     ESTABLISHED
    tcp        0      0 dd953be2-cf3d-49f:40654 216.24.57.252:https     ESTABLISHED
    tcp        0      0 localhost:40825         localhost:57780         ESTABLISHED
    tcp        0      0 dd953be2-cf3d-49f:47874 52.148.89.206:https     ESTABLISHED
    tcp        0      0 dd953be2-cf3d-49f:51180 52.148.90.111:https     ESTABLISHED
    tcp        0    376 dd953be2-cf3d-49f:50476 216.24.57.252:https     ESTABLISHED
    tcp6       0      0 dd953be2-cf3d-49f:34724 20.197.80.108:https     ESTABLISHED
    tcp6       0      0 dd953be2-cf3d-49f:49852 20.43.185.14:https      ESTABLISHED
    tcp6       0      0 dd953be2-cf3d-49f:41740 20.43.185.14:https      ESTABLISHED
    tcp6       0      0 localhost:57780         localhost:40825         ESTABLISHED
    tcp6       0      0 localhost:43506         localhost:40825         ESTABLISHED
    tcp6       0      0 dd953be2-cf3d-49f:56722 52.239.197.69:https     ESTABLISHED
    udp        0      0 dd953be2-cf3d-49f:39816 168.63.129.16:domain    ESTABLISHED
    udp        0      0 dd953be2-cf3d-49f:33577 168.63.129.16:domain    ESTABLISHED
    Active UNIX domain sockets (w/o servers)
    Proto RefCnt Flags       Type       State         I-Node   Path
    unix  3      [ ]         STREAM     CONNECTED     40774    
    unix  3      [ ]         STREAM     CONNECTED     19462    /run/systemd/journal/stdout
    unix  3      [ ]         DGRAM      CONNECTED     18717    
    unix  3      [ ]         STREAM     CONNECTED     36299    
    unix  3      [ ]         STREAM     CONNECTED     37883    
    unix  3      [ ]         STREAM     CONNECTED     20040    /run/dbus/system_bus_socket
    unix  3      [ ]         STREAM     CONNECTED     18345    
    unix  3      [ ]         STREAM     CONNECTED     330002   /run/systemd/journal/stdout
    unix  3      [ ]         STREAM     CONNECTED     15396    
    unix  3      [ ]         STREAM     CONNECTED     40769    
    unix  3      [ ]         STREAM     CONNECTED     18735    /run/systemd/journal/stdout
    unix  3      [ ]         STREAM     CONNECTED     36917    /tmp/CoreFxPipe_VSLS
    .
    .
    .
    unix  3      [ ]         STREAM     CONNECTED     40768    
    unix  3      [ ]         STREAM     CONNECTED     37092    
    unix  3      [ ]         STREAM     CONNECTED     18736    /run/systemd/journal/stdout
    unix  3      [ ]         STREAM     CONNECTED     330815   
    unix  3      [ ]         STREAM     CONNECTED     41517    
    unix  2      [ ]         STREAM     CONNECTED     645738   /run/docker.sock
    unix  3      [ ]         STREAM     CONNECTED     35209    
    ```
    - Display all active network connections:
    ```bash
    netstat -a
    ```
    - Display all executables
    ```bash
    netstat -b
    ```
    - Display the process owning ports
    ```bash
    netstat -o
    ```
    - Display all TCP connections:
    ```bash
    netstat -t
    ```
    - Display all UDP connections:
    ```bash
    netstat -u
    ```
    - Display routing table:
    ```bash
    netstat -r
    ```
    - Display interface statistics:
    ```bash
    netstat -i
    ```
    - Display multicast memberships:
    ```bash
    netstat -g
    ```
    - Display protocal statistics (Active and passive ports and failed and reset connection):
    ```bash
    netstat -es
    ```
    - Summary of UDP packets sent and received:
    ```bash
    netstat -rn
    ```
    - Display all address entries using the -a switch
    ```bash
    arp -a
    ```
    - Add an address in arp using `s` switch
    ```windows
    # windows
    arp -s 172.131.1.1 00-00-00-00-00-00
    ```
    - 


## Script with Powershell
- PowerShell combines the features of a scripting language with command line utilities and commandlets as well as the ability to interface to the Windows management instrumentation or WMI system. 
- Commandlets are a new concept with PowerShell. They use a standard naming convention that follows a verb noun pattern such as `get help` `gets event log,` `get process,` and `set service.` 
- The get verb displays information about the noun and the set verb modifies or sets some, or all of that information.There are around a hundred verbs that can be used. 

```powershell


-----------
# Creating variables
## Store a string
PS C:\WINDOWS\system32> $name = "D-Sensei"

PS C:\WINDOWS\system32> echo $name
D-Sensei
## Store a int
PS C:\WINDOWS\system32> $age = 21

PS C:\WINDOWS\system32> echo $age
21

## Store a datatype list
PS C:\WINDOWS\system32> $list = 1 ,2 ,3 ,4 ,5

PS C:\WINDOWS\system32> echo $list
1
2
3
4
5

PS C:\WINDOWS\system32> ($list).Count
5

## If Else
PS C:\WINDOWS\system32> if($list[1] -gt 0)
{
echo "$list[1] is greater than 0"
}
1 2 3 4 5[1] is greater than 0

## Foreach Loop

PS C:\WINDOWS\system32> Foreach($val in $list)
{ echo "Element of list are : $val"}
Element of list are : 1
Element of list are : 2
Element of list are : 3
Element of list are : 4
Element of list are : 5

```

## Extend Powershell with Nishang
- [Nishang](https://github.com/samratashok/nishang) is available in the Kali Linux release, but it can also be manually loaded into a Windows system. The zip file can be downloaded from Nikhil's GitHub site shown here. I've already downloaded and extracted the Nishang master contents into C:\nishang. 
    - **Note** that if you want to work with Nishang you'll likely need to turn off real time protection. A number of these scripts are picked up as a threat by antivirus software. You'll also need to run the script as administrator. So make sure you open the PowerShell using Run as Administrator option. I've got PowerShell loaded and running as administrator.
    1.  Type `Set-ExecutionPolicy Unrestricted` on the PowerShell prompt to allow unsigned scripts to be run.
        -  Type `Set-ExecutionPolicy Restricted` to return the execution policy to the default.
    2. Type `gci C:\nishang\ -recurse | Unblock-File` to unblock all scripts in the Nishang directory.
    
    3. Type `Import-Module C:\nishang\nishang.psm1` to import the Nishang module.
    4. `get-command -module nishang` to list the commandlets in the module.
    5. `get-information` to run the basic information gathering commandlet.

    6. `get-help -name Invoke-Mimikatz` to get help on the Invoke-Mimikatz commandlet.
    7. `get-passhashes` to get password hashes
    8. `Invoke-Portscan -startaddress 10.0.2.1 -endaddress 10.0.2.8 -ScanPort` to scan ports on a range of IP addresses. With this we can see the open port.
    9. `Out-word -Payload "powershell.exe -ExecutionPolicy Bypass -noprofile"` to create a word document with an embedded payload.
        - Output:
        ```powershell
        # Create a document with payload
        Saved to file C:\Microsoft Tools\Nishang\Salary_Details.doc
        0
        ```
    10. `Invoke-BruteForce -Port 21 -UserList C:\nishang\user.txt -PassList C:\nishang\pass.txt -Verbose -StopOnSuccess`

    11. `Invoke-Prasadhak` connects to virus total database and checks the executable of all running processes for malware. This rewuires an API key from Virus total, which you can obtain by registering a free account

  
   
## Chapter Quiz
What switch is used to save tcpdump output as a pcap file?
- -w

Which switch or switches are used to identify the operating system?

- -O

The expression nc 10.0.2.8 4545 will listen for connections.
- False

What does the -es switch do when used with netstat?
- shows the number of active and passive ports

We can use DOS commands in Powershell.
- True

What Nishang command do we use if we want to create a maliciously modified excel spreadsheet?
- Out-Excel